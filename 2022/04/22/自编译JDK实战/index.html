<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1,user-scalable=no"><meta name="renderer" content="webkit"><meta name="color-scheme" content="dark light"><meta name="author" content="ainexur"><meta name="description" content="温故 知新"><meta name="keywords" content="博客"><title>编译OpenJDK12实战</title><link rel="icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="//at.alicdn.com/t/font_3242539_utq6ykfq7z.css"><link rel="stylesheet" light-src="https://cdn.staticfile.org/highlight.js/11.5.0/styles/default.min.css" dark-src="https://cdn.staticfile.org/highlight.js/11.5.0/styles/tokyo-night-dark.min.css"><link rel="stylesheet" href="https://fonts.font.im/css?family=Noto+Serif" as="font"><link href="/style/index.css" rel="stylesheet"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="寻人启事" type="application/atom+xml">
</head><body><header class="page-header"><nav><ul class="router-list"><li class="nav-item"> <a href="/">主页</a></li><li class="nav-item"> <a href="/archives/">归档</a></li><li class="nav-item"> <a href="/atom.xml">RSS</a></li></ul><div class="mode-switch"><span class="iconfont icon-DarkTheme"></span></div></nav></header><main><section class="main-content"><section class="post-page"><div class="title-bar"><h1>编译OpenJDK12实战</h1><div class="post-info"><span>2022-04-22 03:30:11</span><span class="tags"><a href="/tags/JDK/">#JDK</a><a href="/tags/jvm3/">#jvm3</a></span></div></div><article> <div class="content"><p>跟着深入理解jvm3一书中实战操作，自编译JDK12</p>
<h3 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h3><h4 id="直接下载zip（不推荐）"><a href="#直接下载zip（不推荐）" class="headerlink" title="直接下载zip（不推荐）"></a>直接下载zip（不推荐）</h4><p>原书从<a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk/jdk12/">官网源码</a>下载（不推荐</p>
<h4 id="GItHub仓库（推荐）"><a href="#GItHub仓库（推荐）" class="headerlink" title="GItHub仓库（推荐）"></a>GItHub仓库（推荐）</h4><p><del>推荐直接GitHub拉（最近clone的速度快了挺多），大概两三分钟就clone完毕。</del>直接clone到的是JDK最新版本，详解看 <a href="./#%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91">进行编译</a> 第2步。</p>
<pre><code class="hljs shell">git clone https://github.com/openjdk/jdk</code></pre>

<h3 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h3><p>我用的和书中一样的ubuntu18，我的是<code>Ubuntu 18.04.6 LTS x86_64</code></p>
<h3 id="构建编译环境"><a href="#构建编译环境" class="headerlink" title="构建编译环境"></a>构建编译环境</h3><ol>
<li><p>依赖</p>
<pre><code class="hljs shell">sudo apt-get install build-essential</code></pre>
</li>
<li><p>安装OpenJDK 11。要编译大版本为N的JDK，要另外准备一个大版本号至少为N-1的、已编译好的JDK。</p>
<pre><code class="hljs shell">sudo apt-get install openjdk-11-jdk</code></pre></li>
</ol>
<h3 id="进行编译"><a href="#进行编译" class="headerlink" title="进行编译"></a>进行编译</h3><ol>
<li><p>获取编译参数帮助</p>
<pre><code class="hljs shell">bash configure --help</code></pre>

<p>我这里因为没有安装<code>autoconf</code>会报一个错误<code>Error: Cannot find autoconf</code>，遂安装后再执行获取<code>help</code>即可</p>
<pre><code class="hljs shell">sudo apt-get install autoconf</code></pre>


</li>
<li><p>配置</p>
<p>编译FastDebug版、仅含Server模式的HotSpot虚拟机</p>
<pre><code class="hljs shell">bash configure --enable-debug --with-jvm-variants=server</code></pre>

<p>在我的ubuntu环境执行配置命令，接收到以下错误</p>
<pre><code class="hljs shell">configure: (Your Boot JDK version must be one of: 18 19)
configure: Could not find a valid Boot JDK. OpenJDK distributions are available at http://jdk.java.net/.
configure: This might be fixed by explicitly setting --with-boot-jdk
configure: error: Cannot continue
configure exiting with result code 1</code></pre>

<p>很明显的提示了前置的JDK版本不对，因为之前安装的是JDK11，要求18或19。由于我直接从GitHub上拉的最新仓库的源码版本为JDK19的，所以需要替换为JDK12的版本。从仓库的Tags找到JDK12的源码，下载解压后，进入该解压目录从新执行</p>
<pre><code class="hljs shell">bash configure --enable-debug --with-jvm-variants=server</code></pre>

<p>缺少一些依赖库，报错，按照提示一个个安装，再重新跑一次配置命令即可</p>
<pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">configure: error: Could not find all X11 headers (shape.h Xrender.h Xrander.h XTest.h Intrinsic.h). You might be able to fix this by running <span class="hljs-string">&#x27;sudo apt-get install libx11-dev libxext-dev libxrender-dev libxrandr-dev libxtst-dev libxt-dev&#x27;</span>.</span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">configure exiting with result code 1</span>
sudo apt-get install libx11-dev libxext-dev libxrender-dev libxrandr-dev libxtst-dev libxt-dev
<span class="hljs-meta prompt_">#</span><span class="language-bash">configure: error: Could not find fontconfig! You might be able to fix this by running <span class="hljs-string">&#x27;sudo apt-get install libfontconfig1-dev&#x27;</span>.</span> 
<span class="hljs-meta prompt_">#</span><span class="language-bash">configure exiting with result code 1</span>
sudo apt-get install libfontconfig1-dev
<span class="hljs-meta prompt_">#</span><span class="language-bash">configure: error: Could not find alsa! You might be able to fix this by running <span class="hljs-string">&#x27;sudo apt-get install libasound2-dev&#x27;</span>.</span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">configure exiting with result code 1</span>
sudo apt-get install libasound2-dev</code></pre>

<p>输出成功后输出：</p>
<pre><code class="hljs shell">====================================================
A new configuration has been successfully created in
/home/k/Downloads/jdk-jdk-12-27/build/linux-x86_64-server-fastdebug
using configure arguments &#x27;--enable-debug --with-jvm-variants=server&#x27;.

Configuration summary:
* Debug level:    fastdebug
* HS debug level: fastdebug
* JVM variants:   server
* JVM features:   server: &#x27;aot cds cmsgc compiler1 compiler2 epsilongc g1gc graal jfr jni-check jvmci jvmti management nmt parallelgc serialgc services shenandoahgc vm-structs zgc&#x27; 
* OpenJDK target: OS: linux, CPU architecture: x86, address length: 64
* Version string: 12-internal+0-adhoc.k.jdk-jdk-12-27 (12-internal)

Tools summary:
* Boot JDK:       openjdk version &quot;11.0.14.1&quot; 2022-02-08 OpenJDK Runtime Environment (build 11.0.14.1+1-Ubuntu-0ubuntu1.18.04) OpenJDK 64-Bit Server VM (build 11.0.14.1+1-Ubuntu-0ubuntu1.18.04, mixed mode, sharing)  (at /usr/lib/jvm/java-11-openjdk-amd64)
* Toolchain:      gcc (GNU Compiler Collection)
* C Compiler:     Version 7.5.0 (at /usr/bin/gcc)
* C++ Compiler:   Version 7.5.0 (at /usr/bin/g++)

Build performance summary:
* Cores to use:   3
* Memory limit:   3919 MB</code></pre>

<blockquote>
<p>在configure命令以及后面的make命令的执行过程中，会在“build&#x2F;配置名称”目录下产生如下目录结<br>构。不常使用C&#x2F;C++的读者要特别注意，如果多次编译，或者目录结构成功产生后又再次修改了配<br>置，必须先使用“make clean”和“make dist-clean”命令清理目录，才能确保新的配置生效。编译产生的目<br>录结构以及用途如下所示：</p>
</blockquote>
</li>
<li><p>make images</p>
<p>前排提示，执行该命令之前分配多点内存和核心数（虚拟机下的话）</p>
<pre><code class="hljs shell">make images</code></pre>

<p>等待…</p>
<p>出错：内存不足(分配了4G)，由于是虚拟机，swap的空间也挺小1.4G。</p>
<pre><code class="hljs shell">OpenJDK 64-Bit Server VM warning: INFO: os::commit_memory(0x00000000ae800000, 547356672, 0) failed; error=&#x27;Not enough space&#x27; (errno=12)
<span class="hljs-meta prompt_">#</span><span class="language-bash"></span>
<span class="language-bash"><span class="hljs-comment"># There is insufficient memory for the Java Runtime Environment to continue.</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">Native memory allocation (mmap) failed to map 547356672 bytes <span class="hljs-keyword">for</span> committing reserved memory.</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">An error report file with more information is saved as:</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">/home/k/Downloads/jdk-jdk-12-27/make/gensrc/hs_err_pid76398.<span class="hljs-built_in">log</span></span>
</code></pre>

<p>可以使用命令查看内存和swap大小</p>
<pre><code class="hljs shell">free -m</code></pre>

<p>我给虚拟机分配了8G内存，重新编译得出如下：</p>
<pre><code class="hljs shell">Stopping sjavac server
Finished building target &#x27;images&#x27; in configuration &#x27;linux-x86_64-server-fastdebug&#x27;</code></pre>

<p>进入提示的路径<code>./build/linux-x86_64-server-fastdebug/jdk/bin</code>，执行version命令</p>
<pre><code class="hljs shell">./java -version</code></pre>

<p>输出</p>
<pre><code class="hljs shell">openjdk version &quot;12-internal&quot; 2019-03-19
OpenJDK Runtime Environment (fastdebug build 12-internal+0-adhoc.k.jdk-jdk-12-27)
OpenJDK 64-Bit Server VM (fastdebug build 12-internal+0-adhoc.k.jdk-jdk-12-27, mixed mode)</code></pre>

<p>编译完成。</p>
</li>
</ol>
</div></article><div class="copyright-wrapper"><p>原文作者:<a href="https://ainexur.github.io">ainexur</a></p><p>原文链接:<a href="https://ainexur.github.io/2022/04/22/%E8%87%AA%E7%BC%96%E8%AF%91JDK%E5%AE%9E%E6%88%98/">编译OpenJDK12实战</a></p><p>发表日期: 2022-04-22 03:30:11</p><p>更新日期: 2023-04-02 23:52:57</p><p>版权声明: 本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class="post-pager"><div class="prev"><a href="/2022/04/22/ubuntu%E4%B8%8B%E6%96%87%E4%BB%B6%E6%A0%A1%E9%AA%8C/" title="ubuntu下文件校验">上一篇 ubuntu下文件校验</a></div><div class="next"> <a href="/2022/03/27/Typora%E9%85%8D%E7%BD%AEPicGo%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8COSS%E5%9B%BE%E5%BA%8A/" title="Typora配置PicGo使用阿里OSS图床">下一篇 Typora配置PicGo使用阿里OSS图床</a></div></div><link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.css"/><script src="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.js"></script><div id="gitalk-container"></div><script>new Gitalk({
  clientID: '',
  clientSecret: '',
  repo: '',
  owner: '',
  admin: '',
  id: location.pathname.substr(0, 48),
  distractionFreeMode: true,
  labels: ['Gitalk'],
  title: '编译OpenJDK12实战',
}).render('gitalk-container');</script></section></section></main><footer class="footer-page"><div><span>Powered by</span><a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a><span>| Theme</span><a target="_blank" rel="noopener" href="https://github.com/techmovie/hexo-theme-instapaper">instapaper</a></div></footer><script src="/scripts/dark.js"></script><script src="/scripts/post.js"></script></body></html>